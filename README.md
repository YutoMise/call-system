# call-system

整理券番号と診察室を案内する、高機能な呼び出しシステムです。

## ✨ 主な機能

*   **呼び出し機能:**
    *   Sender: Receiverに対してチャンネルを指定し、整理券番号・診察室番号を送信します。
    *   Receiver: Senderから届いた情報を合成音声で読み上げます。
*   **管理者機能:**
    *   **チャンネル管理:** Web UIからチャンネルの追加・編集・削除が可能です。
    *   **詳細設定:** チャンネルごとにパスワード、診察室数、受付ボタンの表示有無、日本語・英語別の音声IDを設定できます。
    *   **システムログ:** リアルタイムでシステムログを閲覧できます。ログのフィルタリングやチャンネルごとの表示にも対応しています。

### ユーザー補助機能

* 「*」キーの押下でTabと同等の処理を行うように
* 「-」キーの押下でBackSpaceと同等の処理を行うように
* ウインドウのクリックで整理券番号のテキスト入力にフォーカスが合うように


## 🛠️ 使用技術

* **言語:** JavaScript (Node.js [v22.14.0])
* **フレームワーク:** Express.js
* **データベース:** なし
* **リアルタイム通信:** SSE(Server-Sent Events)
* **パッケージマネージャー:** npm
* **その他:** crypto, dotenv, express-session

## 🚀 セットアップとローカルでの実行方法

### 必要なもの

* Node.js (推奨バージョン: v22.14.0)
* npm (推奨バージョン: v11.3)

### 手順

1.  **リポジトリをクローン:**
    ```shell
    git clone https://github.com/YutoMise/call-system.git
    cd call-system
    ```

2.  **依存パッケージのインストール:**
    ```shell
    npm install
    ```
3.  **アプリケーションの起動・停止:**  
    Shell上でのコマンド実行・停止

    ```shell
    # 起動
    npm start
    # 停止
    (キーボードショットカット)Ctrl + C
    ```  
    Dockerを使用したコンテナ操作
    ```shell
    # 起動
    docker compose up -d
    # 停止
    docker compose down --rmi all
    ```  
    crontabで定期実行を行う  
    ```shell
    sudo crontab -e
    # 1. 毎日5:00にdockerコンテナの起動を行う
    0 5 * * * cd /<userpath>/call-system && /<dockerpath>/docker compose up -d >> /<userpath>/call-system/logs/cron_docker.log 2>&1

    # 2. 毎日22:55にその日のログファイルを格納する
    55 22 * * * cd /<userpath>/call-system && /<dockerpath>/docker compose logs >> /<userpath>/call-system/logs/$(date +\%Y\%m\%d).log 2>&1

    # 3. 毎日23:00にdockerコンテナを停止させる
    0 23 * * * cd /<userpath>/call-system && /<dockerpath>/docker compose down --rmi all >> /<userpath>/call-system/logs/cron_docker.log 2>&1
    ```

4.  **アクセス:**
    起動後、以下のURLにアクセスします。
    *   **メインページ:** `http://localhost:3002`
    *   **呼び出し受け取りページ:** `http://localhost:3002/receiver`
    *   **管理者ページ:** `http://localhost:3002/admin/channel/edit`

    ポート番号は `.env` ファイルの `PORT` 変数で変更可能です。

## 📜 バージョン履歴

| バージョン | 主な変更点                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - |
| **v1.3.0** | **管理者機能の大幅強化**<br>・チャンネル管理UIを刷新し、Webフォームからの直感的な追加・編集に対応<br>・チャンネル設定項目を拡張（診察室数、受付使用有無など）<br>・**システムログ閲覧ページを新規追加**（フィルタリング、自動更新、チャンネル別表示機能付き） |
| **v1.2.0** | **音声機能の強化と多言語対応**<br>・日本語(VOICEVOX)・英語(Kokoro TTS)の多言語呼び出しに対応<br>・チャンネルごとに使用する音声IDを設定可能に (`voiceConfig`)<br>・音声ファイルを事前生成するための各種スクリプトを追加<br>・音声選択のためのサンプル音声再生機能を追加                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - |
| **v1.1.0** | **管理者機能の導入**<br>・管理者ログイン機能を追加<br>・`channels.json`をWeb UIから直接編集する機能を追加                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        - |
| **v.1.0.0**  | **初期リリース**<br>・基本的な呼び出し機能（Sender/Receiver）<br>・SSEによるリアルタイム通信<br>・`channels.json`ファイルによるチャンネル管理                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       - |


## 🎵 音声生成スクリプト

本システムでは事前生成音声方式を採用しており、以下のスクリプトを使用して音声ファイルを生成します。

### 日本語音声生成（VOICEVOX）

#### `scripts/generate-audio.js`
VOICEVOX を使用して日本語の音声ファイルを生成します。

**使用方法:**
```bash
node scripts/generate-audio.js [オプション] [開始番号] [終了番号]
```

**オプション:**
- `--voice-id <id>`: 音声ID（フォルダ名）[デフォルト: voice1]
- `--speaker-id <id>`: VoicevoxスピーカーID [デフォルト: 1]
- `--pitch <value>`: ピッチ（-0.15〜0.15）[デフォルト: 0.0]
- `--speed <value>`: 速度（0.5〜2.0）[デフォルト: 1.0]
- `--help, -h`: ヘルプを表示

**使用例:**
```bash
# voice1で整理券1-100番を生成（デフォルト設定）
node scripts/generate-audio.js 1 100

# voice2でスピーカーID 8、ピッチ0.1、速度1.2で生成
node scripts/generate-audio.js --voice-id voice2 --speaker-id 8 --pitch 0.1 --speed 1.2 1 300
```

**生成されるファイル:**
- `public/audio/pregenerated/{voice-id}/ticket_{番号}.mp3`: 「呼び出し番号 X番のかた」
- `public/audio/pregenerated/{voice-id}/room_{番号}.mp3`: 「X番診察室へお越しください。」

#### `scripts/generate-samples.js`
VOICEVOX の各話者でサンプル音声を生成します（音声選択用）。

**使用方法:**
```bash
node scripts/generate-samples.js [話者ID1] [話者ID2] ...
```

**使用例:**
```bash
# 全話者でサンプル生成
node scripts/generate-samples.js

# 特定の話者のみ
node scripts/generate-samples.js 1 3 8
```

### 英語音声生成（Kokoro TTS）

#### `scripts/generate-audio-kokoro.js`
Kokoro TTS を使用して英語の音声ファイルを生成します。

**使用方法:**
```bash
node scripts/generate-audio-kokoro.js [オプション] [開始番号] [終了番号]
```

**オプション:**
- `--voice-id <id>`: 音声ID（フォルダ名）[デフォルト: voice2]
- `--voice <voice>`: Kokoro音声名 [デフォルト: af_bella]
- `--speed <value>`: 速度（0.5〜2.0）[デフォルト: 1.0]
- `--help, -h`: ヘルプを表示

**使用例:**
```bash
# voice2でaf_sarahの音声を生成
KOKORO_TTS_URL=http://localhost:8880 node scripts/generate-audio-kokoro.js --voice-id voice2 --voice af_sarah --speed 1.0 1 300

# 環境変数を設定して実行
export KOKORO_TTS_URL=http://localhost:8880
node scripts/generate-audio-kokoro.js --voice af_sarah 1 100
```

**生成されるファイル:**
- `public/audio/pregenerated/{voice-id}/ticket_{番号}.mp3`: 「Ticket number X,」
- `public/audio/pregenerated/{voice-id}/room_{番号}.mp3`: 「please come to examination room X.」

#### `scripts/generate-samples-kokoro.js`
Kokoro TTS の各音声でサンプル音声を生成します（音声選択用）。

**使用方法:**
```bash
node scripts/generate-samples-kokoro.js [音声名1] [音声名2] ...
```

**使用例:**
```bash
# 全音声でサンプル生成
KOKORO_TTS_URL=http://localhost:8880 node scripts/generate-samples-kokoro.js

# 特定の音声のみ
KOKORO_TTS_URL=http://localhost:8880 node scripts/generate-samples-kokoro.js af_sarah af_bella
```

### ユーティリティスクリプト

#### `scripts/update-speakers.js`
VOICEVOX エンジンから最新の話者一覧を取得してファイルを更新します。

**使用方法:**
```bash
node scripts/update-speakers.js
```

**機能:**
- VOICEVOX APIから話者一覧を取得
- `data/voicevox-speakers.json` を更新
- 新しい話者が追加された際に実行

### 注意事項

1. **VOICEVOX**: `http://localhost:50021` で動作している必要があります
2. **Kokoro TTS**: `http://localhost:8880` で動作している必要があります
3. **環境変数**: `VOICEVOX_URL` や `KOKORO_TTS_URL` で接続先を変更可能
4. **ファイル形式**: 全てMP3形式で出力されます
5. **既存ファイル**: 同名ファイルが存在する場合はスキップされます

---

## 🙏 謝辞 (Acknowledgements)

本プロジェクトでは、以下の素晴らしい音声合成ライブラリおよびキャラクターを使用させていただいております。

### VOICEVOX

*   四国めたん, ずんだもん, 春日部つむぎ, 雨晴はう
*   波音リツ, 玄野武宏, 白上虎太郎, 青山龍星
*   冥鳴ひまり, 九州そら, もち子(cv 明日葉よもぎ), 剣崎雌雄
*   WhiteCUL, 後鬼, No.7, ちび式じい
*   櫻歌ミコ, 小夜/SAYO, ナースロボ＿タイプＴ, †聖騎士 紅桜†
*   雀松朱司, 麒ヶ島宗麟, 春歌ナナ, 猫使アル
*   猫使ビィ, 中国うさぎ, 栗田まろん, あいえるたん
*   満別花丸, 琴詠ニア, Voidoll(CV:丹下桜), ぞん子
*   中部つるぎ

---

## 作者
YutoMise